<!DOCTYPE html>
<html lang="en">
<!--begin::Head-->

<head th:replace="fragments/partial :: page_head('New User', 'none')" />
<!--end::Head-->
<!--begin::Body-->
<style>
/* Reset các style mặc định của table */
.container {
    margin-top: 50px;
}

.table {
    border-radius: 10px;
    border: 1px solid #ccc;
}

.table th, .table td {
    border: 1px solid #ccc;
}

.table-hover tbody tr:hover {
    background-color: #f5f5f5;
}

.table thead th {
       background-color: #a5a1a1;
    color: #fff;
    font-weight: bold;
}

.table td:last-child, .table th:last-child {
    width: 100px; /* Điều chỉnh theo nhu cầu */
}



.table td:last-child a:hover {
    text-decoration: underline;
}
#doctorInfo {
    max-height: 80px; /* Giới hạn chiều cao của phần tử */
    overflow-y: scroll; /* Cho phép thanh cuộn ngay trong phần tử */
    padding: 10px;
    background-color: #f9f9f9;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Đổ bóng cho phần tử */
}

/* Định dạng cho các đoạn văn bản trong phần thông tin của bác sĩ */
#doctorInfo p {
    margin-bottom: 5px;
}

</style>
<body data-kt-name="metronic" id="kt_app_body" data-kt-app-layout="dark-sidebar" data-kt-app-header-fixed="true"
	data-kt-app-sidebar-enabled="true" data-kt-app-sidebar-fixed="true" data-kt-app-sidebar-hoverable="true"
	data-kt-app-sidebar-push-header="true" data-kt-app-sidebar-push-toolbar="true" data-kt-app-sidebar-push-footer="true"
	data-kt-app-toolbar-enabled="true" class="app-default">
	<!--begin::Theme mode setup on page load-->
	<script>
		if (document.documentElement) {
			const defaultThemeMode = "system";
			const name = document.body.getAttribute("data-kt-name");
			let themeMode = localStorage.getItem(
				"kt_" + (name !== null ? name + "_" : "") + "theme_mode_value"
			);
			if (themeMode === null) {
				if (defaultThemeMode === "system") {
					themeMode = window.matchMedia("(prefers-color-scheme: dark)")
						.matches
						? "dark"
						: "light";
				} else {
					themeMode = defaultThemeMode;
				}
			}
			document.documentElement.setAttribute("data-theme", themeMode);
		}
	</script>
	<!--end::Theme mode setup on page load-->
	<!--begin::App-->
	<div class="d-flex flex-column flex-root app-root" id="kt_app_root">
		<!--begin::Page-->
		<div class="app-page flex-column flex-column-fluid" id="kt_app_page">
			<div th:replace="fragments/header :: header">&nbsp;</div>
			<!--begin::Wrapper-->
			<div class="app-wrapper flex-column flex-row-fluid" id="kt_app_wrapper">
				<div th:replace="fragments/sidebar :: sidebar"></div>
				<!--begin::Main-->
				<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
					<!--begin::Content wrapper-->
					<div class="d-flex flex-column flex-column-fluid">
						<!--begin::Toolbar-->
						<div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
							<!--begin::Toolbar container-->
							<div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
								<!--begin::Page title-->
								<div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
									<!--begin::Title-->
									<h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
										List Appointment
									</h1>
									<!--end::Title-->
									<!--begin::Breadcrumb-->
									<ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
										<!--begin::Item-->
										<li class="breadcrumb-item text-muted">
											<a href="/" class="text-muted text-hover-primary">Home</a>
										</li>
										<!--end::Item-->
										<!--begin::Item-->
										
										<!--end::Item-->
										<!--begin::Item-->
										<li class="breadcrumb-item text-muted"></li>
										<!--end::Item-->
									</ul>
									<!--end::Breadcrumb-->
								</div>
								<!--end::Page title-->
							</div>
							<!--end::Toolbar container-->
						</div>
						<!--end::Toolbar-->
						<!--begin::Content-->
						<div id="kt_app_content" class="app-content flex-column-fluid">
							<!--begin::Content container-->
							<div id="kt_app_content_container" class="app-container container-xxl">
								<!--begin::Card-->
								<div class="card">
									<!--begin::Card header-->
									<div class="card-header border-0 pt-6">
										<!--begin::Card title-->
										<div class="card-title">
											<!--begin::Search-->
											<div class="d-flex align-items-center position-relative my-1">
												<!--begin::Svg Icon | path: icons/duotune/general/gen021.svg-->
												
											
											</div>
											<!--end::Search-->
										</div>
										<!--begin::Card title-->
										<!--begin::Card toolbar-->
										<div class="card-toolbar">
											<!--begin::Toolbar-->
											<div class="d-flex justify-content-end" data-kt-customer-table-toolbar="base">
												<!--begin::Export-->
												
												<!--end::Export-->
												<!--begin::Add customer-->
												
												<!--end::Add customer-->
											</div>
											<!--end::Toolbar-->
											<!--begin::Group actions-->
											<div class="d-flex justify-content-end align-items-center d-none"
												data-kt-customer-table-toolbar="selected">
												<div class="fw-bold me-5">
													<span class="me-2" data-kt-customer-table-select="selected_count"></span>Selected
												</div>
												<button type="button" class="btn btn-danger" data-kt-customer-table-select="delete_selected">
													Delete Selected
												</button>
											</div>
											<!--end::Group actions-->
										</div>
										<!--end::Card toolbar-->
									</div>
									<!--end::Card header-->
									<!--begin::Card body-->
									<div class="card-body pt-0">
										<!--begin::Table-->
												<div class="container mt-5">
												    <h1>List appointment</h1>
												     <form id="filterForm">
        <label for="startDate">From day:</label>
        <input type="date" id="startDate" name="startDate">
        <label for="endDate">To day:</label>
        <input type="date" id="endDate" name="endDate">
        <br>
        <th:block sec:authorize="hasAnyAuthority('ADMIN', 'DOCTOR')">
        <label for="patientName">Search Patient:</label>
        <input type="text" id="patientName" name="patientName">
        </th:block>
        <br>
        <label for="doctorName">Search doctor:</label>
        <input type="text" id="doctorName" name="doctorName">
        <br>
        	
       <th:block sec:authorize="hasAnyAuthority('ADMIN', 'MANAGER')">
    <div id="doctorInfo">
        <!-- Thông tin của từng bác sĩ và số lần xuất hiện -->
    </div>
</th:block>

        
   </form>
												    <table class="table table-hover" id="appointmentList">
												        <thead>
												            <tr>
												              	<th scope="col">STT</th>
												                <th scope="col">Patient name</th>
												                <th scope="col">Appointment date</th>
												                <th scope="col">Appointment period</th>
												                <th scope="col">Specialty</th>
												                <th scope="col">symptom</th>
												              	
												                <th scope="col" id="doctorHeader"> Doctor</th>
												               
												                <th scope="col">Status</th>
												             
												                  <th:block sec:authorize="hasAnyAuthority('ADMIN', 'MANAGER')">
												                <th scope="col">Arrange a doctor's examination</th>
												              	
												                </th:block>
												                <th:block sec:authorize="hasAnyAuthority('DOCTOR', 'MANAGER')">
												                <th scope="col">Schedule a follow-up visit</th>
												                </th:block>
												            </tr>
												        </thead>
												        <tbody>
												            <!-- Sử dụng vòng lặp Thymeleaf để lặp qua danh sách các cuộc hẹn -->
												            <tr th:each="appointment,iterStat : ${appointments}">
												                <td th:text="${iterStat.index + 1}"></td> 
												              <td>
    															<a th:href="@{/appointmentUserLogin/patient/{patientId}(patientId=${appointment.patientUser.id})}" th:text="${appointment.patientUser.fullName}"></a>
																</td>

												                <td th:text="${appointment.appointmentDate}" name="appointmentDate"></td>
												                <td th:text="${appointment.appointmentPeriod}"></td>
												                <td th:text="${appointment.specialties.nameSpecialty}"></td>
												                
												                <td th:text="${appointment.symptoms}"></td>
												                 <td>
																    <span th:if="${appointment.doctor != null}" th:text="${appointment.doctor.fullName}" class="doctorName"></span>
																</td>
															
																<td th:text="${appointment.arrived}"></td>
																
																<th:block sec:authorize="hasAnyAuthority('ADMIN', 'MANAGER')">
																<td>
												                    <a  th:href="@{/appointmentUserLogin/edit/{id}(id=${appointment.id})}">Xếp</a>
												    
												                </td>
												                
				
												                </th:block>
												                	<th:block sec:authorize="hasAnyAuthority('DOCTOR', 'MANAGER')">
												                <td>
												                <a  th:href="@{/followupappointments/{id}(id=${appointment.id})}">Tái khám</a>
												                </td>
												                </th:block>
												            </tr>
												        </tbody>
												        
												    </table>


												    
												</div>
										
										<!--end::Table-->
										<!--begin::Paginate-->
										
										<!--end::Paginate-->
									</div>
									<!--end::Card body-->
								</div>
								<!--end::Card-->
								<!--begin::Modals-->
								<!--begin::Modal - User - Add-->
								<div class="modal fade" id="kt_modal_add_customer" tabindex="-1" aria-hidden="true">
									<!--begin::Modal dialog-->
									<div class="modal-dialog modal-dialog-centered mw-650px">
										<!--begin::Modal content-->
										<div class="modal-content">
											<!--begin::Form Trung3T-->
											<form class="form" th:action="@{users/add}" id="kt_modal_add_customer_form"
												data-kt-redirect="users" method="post">
												<!--begin::Modal header-->
												<div class="modal-header" id="kt_modal_add_customer_header">
													<!--begin::Modal title-->
													<h2 class="fw-bold">New user</h2>
													<!--end::Modal title-->
													<!--begin::Close-->
													<div id="kt_modal_add_customer_close" class="btn btn-icon btn-sm btn-active-icon-primary">
														<!--begin::Svg Icon | path: icons/duotune/arrows/arr061.svg-->
														<span class="svg-icon svg-icon-1">
															<svg width="24" height="24" viewBox="0 0 24 24" fill="none"
																xmlns="http://www.w3.org/2000/svg">
																<rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1"
																	transform="rotate(-45 6 17.3137)" fill="currentColor" />
																<rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)"
																	fill="currentColor" />
															</svg>
														</span>
														<!--end::Svg Icon-->
													</div>
													<!--end::Close-->
												</div>
												<!--end::Modal header-->
												<!--begin::Modal body-->
												<div class="modal-body py-10 px-lg-17">
													<!--begin::Scroll-->
													<div class="scroll-y me-n7 pe-7" id="kt_modal_add_customer_scroll" data-kt-scroll="true"
														data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto"
														data-kt-scroll-dependencies="#kt_modal_add_customer_header"
														data-kt-scroll-wrappers="#kt_modal_add_customer_scroll" data-kt-scroll-offset="300px">
														<!--begin::Input group-->
														<div class="fv-row mb-7">
															<!--begin::Label-->
															<label class="required fs-6 fw-semibold mb-2">First Name</label>
															<!--end::Label-->
															<!--begin::Input-->
															<input type="text" class="form-control form-control-solid" placeholder="" name="firstname"
																value="" />
															<!--end::Input-->
														</div>
														<!--end::Input group-->
														<!--begin::Input group-->
														<div class="fv-row mb-7">
															<!--begin::Label-->
															<label class="required fs-6 fw-semibold mb-2"> Last Name</label>
															<!--end::Label-->
															<!--begin::Input-->
															<input type="text" class="form-control form-control-solid" placeholder="" name="lastname"
																value="" />
															<!--end::Input-->
														</div>
														<!--end::Input group-->
														<!--begin::Input group-->
														<div class="fv-row mb-7">
															<!--begin::Label-->
															<label class="fs-6 fw-semibold mb-2">
																<span class="required">Email</span>
																<i class="fas fa-exclamation-circle ms-1 fs-7" data-bs-toggle="tooltip"
																	title="Email address must be active"></i>
															</label>
															<!--end::Label-->
															<!--begin::Input-->
															<input type="email" class="form-control form-control-solid" placeholder="" name="email"
																value="" />
															<!--end::Input-->
														</div>
														<!--end::Input group-->
														<!--begin::Switch-->
														<!--begin::Label-->
														<label class="fs-6 fw-semibold mb-2">
															<span>Enabled</span>
														</label>
														<!--end::Label-->
														<label class="form-check form-switch form-check-custom form-check-solid">
															<!--begin::Input-->
															<input class="form-check-input" name="enabled" type="checkbox" value="1"
																id="" checked="checked" />
															<!--end::Input-->
														</label>
														<!--end::Switch-->

													</div>
													<!--end::Scroll-->
												</div>
												<!--end::Modal body-->
												<!--begin::Modal footer-->
												<div class="modal-footer flex-center">
													<!--begin::Button-->
													<button type="reset" id="kt_modal_add_customer_cancel" class="btn btn-light me-3">
														Discard
													</button>
													<!--end::Button-->
													<!--begin::Button-->
													<button type="submit" id="kt_modal_add_customer_submit" class="btn btn-primary">
														<span class="indicator-label">Submit</span>
														<span class="indicator-progress">Please wait...
															<span class="spinner-border spinner-border-sm align-middle ms-2"></span></span>
													</button>
													<!--end::Button-->
												</div>
												<!--end::Modal footer-->
											</form>
											<!--end::Form-->
										</div>
									</div>
								</div>
								<!--end::Modal - Customers - Add-->
								<!--begin::Modal - Export Customers-->
								<div class="modal fade" id="kt_customers_export_modal" tabindex="-1" aria-hidden="true">
									<!--begin::Modal dialog-->
									<div class="modal-dialog modal-dialog-centered mw-650px">
										<!--begin::Modal content-->
										<div class="modal-content">
											<!--begin::Modal header-->
											<div class="modal-header">
												<!--begin::Modal title-->
												<h2 class="fw-bold">Export Customers</h2>
												<!--end::Modal title-->
												<!--begin::Close-->
												<div id="kt_customers_export_close" class="btn btn-icon btn-sm btn-active-icon-primary">
													<!--begin::Svg Icon | path: icons/duotune/arrows/arr061.svg-->
													<span class="svg-icon svg-icon-1">
														<svg width="24" height="24" viewBox="0 0 24 24" fill="none"
															xmlns="http://www.w3.org/2000/svg">
															<rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1"
																transform="rotate(-45 6 17.3137)" fill="currentColor" />
															<rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)"
																fill="currentColor" />
														</svg>
													</span>
													<!--end::Svg Icon-->
												</div>
												<!--end::Close-->
											</div>
											<!--end::Modal header-->
											<!--begin::Modal body-->
											<div class="modal-body scroll-y mx-5 mx-xl-15 my-7">
												<!--begin::Form-->
												<form id="kt_customers_export_form" class="form" th:action="@{/users/export}" method="post">
													<!--begin::Input group-->
													<div class="fv-row mb-10">
														<!--begin::Label-->
														<label class="fs-5 fw-semibold form-label mb-5">Select Export Format:</label>
														<!--end::Label-->
														<!--begin::Input-->
														<select data-control="select2" data-placeholder="Select a format" data-hide-search="true"
															name="format" class="form-select form-select-solid">
															<option value="excell">Excel</option>
															<option value="pdf">PDF</option>
															<option value="csv">CSV</option>
														</select>
														<!--end::Input-->
													</div>
													<!--end::Input group-->
													<!--begin::Input group-->
													<div class="fv-row mb-10">
														<!--begin::Label-->
														<label class="fs-5 fw-semibold form-label mb-5">Select Date Range:</label>
														<!--end::Label-->
														<!--begin::Input-->
														<input class="form-control form-control-solid" placeholder="Pick a date" name="date" />
														<!--end::Input-->
													</div>
													<!--end::Input group-->
													<!--begin::Actions-->
													<div class="text-center">
														<button type="reset" id="kt_customers_export_cancel" class="btn btn-light me-3">
															Discard
														</button>
														<button type="submit" id="kt_customers_export_submit" class="btn btn-primary">
															<span class="indicator-label">Submit</span>
															<span class="indicator-progress">Please wait...
																<span class="spinner-border spinner-border-sm align-middle ms-2"></span></span>
														</button>
													</div>
													<!--end::Actions-->
												</form>
												<!--end::Form-->
											</div>
											<!--end::Modal body-->
										</div>
										<!--end::Modal content-->
									</div>
									<!--end::Modal dialog-->
								</div>
								<!--end::Modal - Export Customers-->
								<!--end::Modals-->
							</div>
							<!--end::Content container-->
						</div>
						<!--end::Content-->
					</div>
					<!--end::Content wrapper-->
					<!--begin::Footer-->
					<div th:replace="fragments/footer :: footer">&nbsp;</div>
					<!--end::Footer-->
				</div>
				<!--end:::Main-->
			</div>
			<!--end::Wrapper-->
		</div>
		<!--end::Page-->
	</div>
	<!--end::App-->
	<!--begin::Scrolltop-->
	<div id="kt_scrolltop" class="scrolltop" data-kt-scrolltop="true">
		<!--begin::Svg Icon | path: icons/duotune/arrows/arr066.svg-->
		<span class="svg-icon">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect opacity="0.5" x="13" y="6" width="13" height="2" rx="1" transform="rotate(90 13 6)" fill="currentColor" />
				<path
					d="M12.5657 8.56569L16.75 12.75C17.1642 13.1642 17.8358 13.1642 18.25 12.75C18.6642 12.3358 18.6642 11.6642 18.25 11.25L12.7071 5.70711C12.3166 5.31658 11.6834 5.31658 11.2929 5.70711L5.75 11.25C5.33579 11.6642 5.33579 12.3358 5.75 12.75C6.16421 13.1642 6.83579 13.1642 7.25 12.75L11.4343 8.56569C11.7467 8.25327 12.2533 8.25327 12.5657 8.56569Z"
					fill="currentColor" />
			</svg>
		</span>
		<!--end::Svg Icon-->
	</div>
	<!--end::Scrolltop-->
	<!--begin::Javascript-->
	<div th:replace="fragments/partial :: global_script"></div>
	<div th:replace="fragments/partial :: users_script"></div>
	<!--end::Javascript-->
</body>

<script>
function filterAppointments() {
    var patientSearchText = document.getElementById("patientName").value.toLowerCase();
    var doctorSearchText = document.getElementById("doctorName").value.toLowerCase();
    var startDate = document.getElementById("startDate").value;
    var endDate = document.getElementById("endDate").value;

    var appointmentRows = document.querySelectorAll("#appointmentList tbody tr");

    appointmentRows.forEach(function(row) {
        var patientName = row.cells[1].innerText.toLowerCase();
        var doctorName = row.cells[6].innerText.toLowerCase();
        var appointmentDate = row.cells[2].innerText;

        var appointmentDateTime = new Date(appointmentDate).getTime();
        var startDateTime = new Date(startDate).getTime();
        var endDateTime = new Date(endDate).getTime();

        var isPatientMatched = patientName.includes(patientSearchText);
        var isDoctorMatched = doctorName.includes(doctorSearchText);
        var isDateMatched = (!startDate || !endDate) || (appointmentDateTime >= startDateTime && appointmentDateTime <= endDateTime);
        
        if (isPatientMatched && isDoctorMatched && isDateMatched) {
            row.style.display = ""; // Hiển thị hàng nếu tất cả các điều kiện đều được đáp ứng
        } else {
            row.style.display = "none"; // Ẩn hàng nếu không đáp ứng một trong các điều kiện
        }
    });
}

document.addEventListener("DOMContentLoaded", function() {
    filterAppointments(); // Gọi hàm lọc khi trang được tải lần đầu
});

document.getElementById("patientName").addEventListener("input", filterAppointments); // Lắng nghe sự kiện khi người dùng nhập vào ô tìm kiếm bệnh nhân
document.getElementById("doctorName").addEventListener("input", filterAppointments); // Lắng nghe sự kiện khi người dùng nhập vào ô tìm kiếm bác sĩ
document.getElementById("startDate").addEventListener("input", filterAppointments); // Lắng nghe sự kiện khi người dùng thay đổi ngày bắt đầu
document.getElementById("endDate").addEventListener("input", filterAppointments); // Lắng nghe sự kiện khi người dùng thay đổi ngày kết thúc

</script>

<script th:inline="javascript">
    $(document).ready(function() {
        // Thêm sự kiện click cho thẻ <th> "Bác sĩ"
        $('th#doctorHeader').click(function() {
            // Lấy danh sách các hàng trong bảng
            var rows = $('#appointmentList tbody tr').get();
            rows.sort(function(a, b) {
                // Lấy giá trị của cột "Bác sĩ" cho mỗi hàng
                var doctorA = $(a).find('td:eq(6)').text(); // Đặt chỉ số cột "Bác sĩ" của hàng
                var doctorB = $(b).find('td:eq(6)').text(); // Đặt chỉ số cột "Bác sĩ" của hàng
                // So sánh và sắp xếp các hàng dựa trên giá trị của cột "Bác sĩ"
                if (doctorA === "NULL") {
                    return -1; // Di chuyển giá trị null lên đầu
                } else if (doctorB === "NULL") {
                    return 1; // Di chuyển giá trị null lên đầu
                } else {
                    return doctorA.localeCompare(doctorB); // Sắp xếp theo thứ tự bảng chữ cái
                }
            });
            // Cập nhật lại dữ liệu trong bảng sau khi đã sắp xếp
            $.each(rows, function(index, row) {
                $('#appointmentList tbody').append(row);
            });
        });
    });
</script>

<script>
//Tạo một đối tượng để lưu trữ thông tin của các bác sĩ và số lần xuất hiện của họ dựa trên cả tên bác sĩ và ngày của cuộc hẹn
var doctorCounts = {};

// Lấy tất cả các thẻ <span> có class là 'doctorName' và <td> có thuộc tính name là 'appointmentDate'
var doctorSpans = document.querySelectorAll("span.doctorName");
var appointmentDateCells = document.querySelectorAll("td[name='appointmentDate']");

// Duyệt qua từng thẻ và cập nhật đối tượng doctorCounts
for (var i = 0; i < doctorSpans.length; i++) {
    var doctorName = doctorSpans[i].innerText.trim(); // Lấy tên bác sĩ từ thẻ <span>
    var appointmentDate = appointmentDateCells[i].innerText.trim(); // Lấy ngày của cuộc hẹn từ thuộc tính name của ô <td>

    // Chia chuỗi ngày thành các phần: năm, tháng và ngày
    var dateParts = appointmentDate.split("-");
    var year = dateParts[0];
    var month = dateParts[1];
    var day = dateParts[2];
    
    // Tạo chuỗi ngày tháng hiển thị đầy đủ
    var fullDate = day + "/" + month + "/" + year;

    var key = doctorName + "-" + fullDate;
    doctorCounts[key] = (doctorCounts[key] || 0) + 1; // Tăng số lần xuất hiện của bác sĩ và ngày của cuộc hẹn
}

// Hiển thị thông tin của từng bác sĩ, ngày của cuộc hẹn và số lần xuất hiện của họ
var doctorInfoDiv = document.getElementById("doctorInfo");
for (var key in doctorCounts) {
    var count = doctorCounts[key];
    var parts = key.split("-");
    var doctorName = parts[0];
    var appointmentDate = parts[1];
    var doctorInfo = doctorName + " - " + appointmentDate + ": " + count + " cuộc hẹn";
    var paragraph = document.createElement("p");
    paragraph.textContent = doctorInfo;
    doctorInfoDiv.appendChild(paragraph);
}



</script>
    
</html>